<% content_for :title, t('menu.audits') %>
<% heading t('menu.audits')  %>
<% content_for :javascript do %>
  <%= stylesheet_link_tag('/plugin_assets/sequreisp_invoicing/stylesheets/jquery-ui-1.8.14.custom.css') %>
  <%= javascript_include_tag('/plugin_assets/sequreisp_invoicing/javascripts/jquery.ui.datepicker.js') %>
  <style>
    #example_attribute_audit_item{ display:none; }
    .attribute_audit>label{
      display:inline;
      font-weight: normal !important;
    }
  </style>
  <script type="text/javascript">
    var search_conditions = <%= @search.conditions.to_json %>;
    var attributes_audits = <%= attributes_audits_to_json %>;

    datepicker_options = {
          dateFormat: 'yy-mm-dd',
          showOn: "button",
          buttonImage: "/plugin_assets/sequreisp_invoicing/images/calendar.gif",
          buttonImageOnly: true
        }
    $(function(){
        $('.datepicker').datepicker(datepicker_options);
        $('#search_auditable_type_is').change(function(){
          if($(this).val() != ""){
            var model = $(this).val();

            $('.attribute_audit').remove();

            for(var i = 0; i < attributes_audits[model].length; i ++){
              var tmp_item = $('#example_attribute_audit_item').clone().insertBefore('#example_attribute_audit_item');
              tmp_item.removeAttr('id');
              tmp_item.addClass('attribute_audit');
              tmp_item.children('label').html(attributes_audits[model][i][1]);
              tmp_item.children('input').attr('value', attributes_audits[model][i][0]);
            }

            $('#search_type').change();
            $('#changes_select').show();
          }
          else{
            $('.attribute_audit').remove();
            $('#changes_select').hide();
          }
        });
        $('#search_type').change(function(){
          var type = $(this).val();

          $('.attribute_audit').each(function(){
            $(this).children('input').attr('name','search[changes_like_' + type + '][]');
          });
        });

        $('#search_auditable_type_is').change();
        $('#search_type').change();

        if((search_conditions.changes_like_all != undefined) || (search_conditions.changes_like_any != undefined)){

          var data = search_conditions.changes_like_any;

          $('#search_type').children('[value="any"]').attr('selected','selected');
          if(search_conditions.changes_like_all != undefined){
            data = search_conditions.changes_like_all;
            $('#search_type').children('[value="all"]').attr('selected','selected');
          }


          for(var i = 0; i < data.length; i++){
            $('.attribute_audit').children('[value="' + data[i] + '"]').attr('checked','checked');
          }
        }
    });
  </script>
<% end %>
<%= render :partial => "shared/empty_submenu" %>
<div id="busqueda">
<% form_for @search do |f| %>
  <ul>
    <li>
      <%= f.label :user_id_equals, t('activerecord.attributes.audit.user') %>
      <%= f.collection_select :user_id_equals, User.all, :id, :name, :include_blank => t('audits.any_user') %>
    </li>
    <li>
      <%= f.label :action_is, t('activerecord.attributes.audit.action') %>
      <%= f.select :action_is, collect_actions, :include_blank => t('audits.any_action') %>
    </li>
    <li>
      <%= f.label :auditable_type_is, t('activerecord.attributes.audit.auditable_type') %>
      <%= f.select :auditable_type_is, collect_of_auditable_models, :include_blank => t('audits.any_model') %>
    </li>
    <li id="changes_select" style="display:none;">
      <div class="separador"></div>
      <label><%= t('messages.audits.changes_in') %>
        <select id="search_type">
          <option value ="all"><%= t('audits.all') %></option>
          <option value ="any"><%= t('audits.any') %></option>
        </select>
         <%= t('messages.audits.selected_attributes') %>
      </label>
      <div id="example_attribute_audit_item">
        <label></label>
        <input multiple="multiple" type="checkbox">
      </div>
      <div class="separador"></div>
    </li>
    <div sytle="clear: both"></div>
    <li>
      <%= f.label :created_at_greater_than_or_equal_to, t('activerecord.attributes.search.issued_init_date') %>
      <%= f.text_field :created_at_greater_than_or_equal_to , { :class => 'datepicker fix_datetime'} %>
    </li>
    <li>
      <%= f.label :created_at_less_than_or_equal_to, t('activerecord.attributes.search.issued_end_date') %>
      <%= f.text_field :created_at_less_than_or_equal_to , {:class => 'datepicker fix_datetime add_end_of_day_before_submit'} %>
    </li>
    <div sytle="clear: both"></div>
    <li>
      <%= f.submit t('buttons.search') %>
      <%= f.submit t('buttons.reset'),{ :type => "button", :class => "reset"}%>
      <%= f.submit t('buttons.export_to_csv'),{ :name => "to_csv"} %>
      <br><br>
    </li>
  </ul>
<% end %>
</div>
<div class="separador"></div>
	
<div class="main">
  <%= page_entries_info @audits %>
  <table cellspacing="0" cellpadding="0">
    <tbody>
      <tr class="odd">
        <th><%=t 'activerecord.attributes.audit.id' %></th>
        <th><%=t 'activerecord.attributes.audit.created_at' %></th>
        <th><%=t 'activerecord.attributes.audit.auditable_type' %></th>
        <th><%=t 'activerecord.attributes.audit.user' %></th>
        <th><%=t 'activerecord.attributes.audit.action' %></th>
        <th><%=t 'activerecord.attributes.audit.changes' %></th>
        <th><%=t 'activerecord.attributes.audit.version' %></th>
      </tr>

      <% @audits.each_with_index do |audit,i| %>
        <% css_class = i%2 == 0 ? "even" : "odd" %>
        <tr class="<%= css_class %>" >
          <td><%= audit.id %></td>
          <td><%=l audit.created_at, :format => :short %></td>
          <td><%= link_to_auditable(audit) %></td>
          <td><%=h audit.user.name rescue t 'audits.undefined' %></td>
          <td><%=h t('audits.'+audit.action) %></td>
          <td><%= expand_changes(audit.changes, audit.auditable_type) %></td>
          <td>
            <%= audit.version %><br/>
            <%= link_to (h(t 'audits.go_back'), go_back_audit_path(audit)) if audit.action=='update' %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <%= will_paginate @audits %>
</div>


